name: telemetry-pipeline-demo

on:
  workflow_dispatch:
    inputs:
      run_date:
        description: "Optional YYYY-MM-DD (UTC). Leave empty to use today's UTC date."
        required: false
        default: ""
  schedule:
    # Runs daily at 06:15 UTC (change later if you want)
    - cron: "15 6 * * *"

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Resolve run date (UTC)
        id: vars
        shell: bash
        run: |
          if [ -n "${{ inputs.run_date }}" ]; then
            DATE="${{ inputs.run_date }}"
          else
            DATE="$(date -u +%F)"
          fi
          echo "date=$DATE" >> "$GITHUB_OUTPUT"
          echo "Using DATE=$DATE"

      - name: Generate bronze (synthetic data)
        run: |
          DATE="${{ steps.vars.outputs.date }}"
          python --version
          python src/generate_bronze.py --date "$DATE"

      - name: Bronze -> Silver (validate + quarantine + DQ report)
        run: |
          DATE="${{ steps.vars.outputs.date }}"
          python src/bronze_to_silver.py --date "$DATE"

      - name: Silver -> Gold (curated outputs)
        run: |
          DATE="${{ steps.vars.outputs.date }}"
          python src/silver_to_gold.py --date "$DATE"

      - name: Add run summary
        shell: bash
        run: |
          DATE="${{ steps.vars.outputs.date }}"

          echo "## Telemetry pipeline run summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Run date (UTC): $DATE" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Key outputs" >> "$GITHUB_STEP_SUMMARY"
          echo "- Bronze (raw landed): lake/bronze/$DATE/ (plants.csv, assets.csv, sensor_readings.jsonl, work_orders.csv, quality_inspections.csv, generation_meta.json)" >> "$GITHUB_STEP_SUMMARY"
          echo "- Silver (clean readings): lake/silver/$DATE/sensor_readings_clean.csv" >> "$GITHUB_STEP_SUMMARY"
          echo "- Quarantine (rejects): lake/quarantine/$DATE/sensor_readings_rejects.csv" >> "$GITHUB_STEP_SUMMARY"
          echo "- Gold (curated): lake/gold/$DATE/plant_kpis.csv, lake/gold/$DATE/asset_health_daily.csv" >> "$GITHUB_STEP_SUMMARY"
          echo "- Exports: exports/$DATE/plant_kpis.csv" >> "$GITHUB_STEP_SUMMARY"
          echo "- DQ report: reports/dq_$DATE.md" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload run artifacts (downloads)
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-artifacts-${{ steps.vars.outputs.date }}
          path: |
            reports/dq_${{ steps.vars.outputs.date }}.md
            lake/bronze/${{ steps.vars.outputs.date }}/*
            lake/silver/${{ steps.vars.outputs.date }}/sensor_readings_clean.csv
            lake/quarantine/${{ steps.vars.outputs.date }}/*.csv
            lake/gold/${{ steps.vars.outputs.date }}/*.csv
            exports/${{ steps.vars.outputs.date }}/*.csv
